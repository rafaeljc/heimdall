openapi: 3.0.3

info:
  title: Heimdall Control Plane API
  description: |
    Management API for the Heimdall Feature Flag system.
    
    This API allows administrators and services to manage the lifecycle of feature flags.
    It follows RESTful principles, enforces API Key authentication, uses offset-based pagination,
    and implements ETag-based optimistic locking for safe concurrent updates.
  version: 1.0.0
  contact:
    name: Heimdall Team
    url: https://github.com/rafaeljc/heimdall

servers:
  - url: http://localhost:8080/api/v1
    description: Local Development Environment

# ------------------------------------------------------------------------------
# SECURITY
# ------------------------------------------------------------------------------
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Standard API Key authentication. 
        The key must be provided in the `X-API-Key` header.

  schemas:
    # --- Domain Models ---
    Rule:
      type: object
      description: Represents a targeting rule for conditional flag evaluation.
      required: [id, type, value]
      properties:
        id:
          type: string
          example: "rule-123e4567-e89b-12d3-a456-426614174000"
          description: Unique identifier for the rule.
        type:
          type: string
          enum: [USER_ID_LIST, PERCENTAGE]
          example: "USER_ID_LIST"
          description: |
            Rule type discriminator that determines the evaluation strategy:
            - USER_ID_LIST: Matches specific user IDs (allowlist/denylist)
            - PERCENTAGE: Gradual rollout based on consistent hashing
        value:
          type: object
          description: |
            Rule-specific configuration. Structure varies by type:
            - USER_ID_LIST: {"user_ids": ["user1", "user2"]}
            - PERCENTAGE: {"percentage": 50, "attribute": "user_id"}
          oneOf:
            - $ref: '#/components/schemas/UserIDListRuleValue'
            - $ref: '#/components/schemas/PercentageRuleValue'

    UserIDListRuleValue:
      type: object
      required: [user_ids]
      properties:
        user_ids:
          type: array
          items:
            type: string
          maxItems: 10000
          example: ["user-123", "user-456"]
          description: List of user IDs to match. Limited to 10,000 entries to maintain P99 < 20ms SLO.

    PercentageRuleValue:
      type: object
      required: [percentage]
      properties:
        percentage:
          type: integer
          minimum: 0
          maximum: 100
          example: 25
          description: Percentage of users to target (0-100).
        attribute:
          type: string
          default: "user_id"
          example: "user_id"
          description: Context attribute to use for consistent hashing. Defaults to "user_id".

    Flag:
      type: object
      description: Represents a feature flag definition matching the PostgreSQL schema.
      required: [id, key, name, enabled, default_value, rules, created_at, updated_at]
      properties:
        id:
          type: integer
          format: int64
          example: 1
          description: Internal surrogate key (SERIAL).
          readOnly: true
        key:
          type: string
          pattern: '^[a-z0-9-]+$'
          minLength: 3
          maxLength: 255
          example: "new-checkout-flow"
          description: |
            Natural key (slug). Must be unique, URL-safe, and contain only lowercase letters, numbers, and hyphens.
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: "New Checkout Flow 2.0"
          description: Human-readable name.
        description:
          type: string
          example: "Enables the React-based checkout page for beta users."
          description: Detailed description (TEXT).
        enabled:
          type: boolean
          example: false
          description: Master switch. If false, the flag is disabled globally.
        default_value:
          type: boolean
          example: false
          description: Fallback value returned when the flag is enabled but no rule matches.
        rules:
          type: array
          items:
            $ref: '#/components/schemas/Rule'
          default: []
          example:
            - id: "rule-1"
              type: "USER_ID_LIST"
              value:
                user_ids: ["beta-user-1", "beta-user-2"]
            - id: "rule-2"
              type: "PERCENTAGE"
              value:
                percentage: 10
                attribute: "user_id"
          description: |
            Ordered list of targeting rules. Evaluated sequentially until first match.
            Empty array means no rules (flag uses default_value).
        created_at:
          type: string
          format: date-time
          readOnly: true
          example: "2025-11-21T11:30:00Z"
          description: Timestamp of creation. Always returned in UTC (ISO 8601 / RFC 3339).
        updated_at:
          type: string
          format: date-time
          readOnly: true
          example: "2025-11-21T11:30:00Z"
          description: Timestamp of last update. Always returned in UTC (ISO 8601 / RFC 3339).
        etag:
          type: string
          readOnly: true
          description: |
            Entity tag representing the current version of the flag.
            Used for optimistic locking (If-Match) in update and delete operations.
            Format: "<sequence_number>".
          example: "5"

    # --- Request Bodies ---
    CreateFlagRequest:
      type: object
      required: [key, name]
      properties:
        key:
          type: string
          pattern: '^[a-z0-9-]+$'
          minLength: 3
          maxLength: 255
          description: Unique key. Cannot be changed after creation.
          example: "dark-mode-beta"
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: "Dark Mode Beta"
        description:
          type: string
        # Optional fields (DB defaults to false if omitted)
        enabled:
          type: boolean
          default: false
        default_value:
          type: boolean
          default: false
        rules:
          type: array
          items:
            $ref: '#/components/schemas/Rule'
          default: []
          description: Optional list of targeting rules. Defaults to empty array if omitted.

    UpdateFlagRequest:
      type: object
      description: |
        Fields to be updated. All fields are optional (PATCH semantics).
        Optimistic locking is enforced via the If-Match header with the ETag value.
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
        enabled:
          type: boolean
        default_value:
          type: boolean
        rules:
          type: array
          items:
            $ref: '#/components/schemas/Rule'
          description: Replaces the entire rules array. To clear rules, send an empty array.

    # --- Responses & Metadata ---
    PaginatedFlagList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Flag'
        pagination:
          type: object
          properties:
            total_items:
              type: integer
              example: 100
            total_pages:
              type: integer
              example: 10
            current_page:
              type: integer
              example: 1
            page_size:
              type: integer
              example: 10

    Error:
      type: object
      properties:
        code:
          type: string
          example: "ERR_INVALID_INPUT"
          description: Machine-readable error code.
        message:
          type: string
          example: "Validation failed for the create request."
          description: Human-readable error message.
        details:
          type: array
          description: Optional list of specific field errors.
          items:
            type: object
            properties:
              field:
                type: string
                example: "key"
              issue:
                type: string
                example: "must contain only lowercase letters"

# Apply security globally
security:
  - ApiKeyAuth: []

# ------------------------------------------------------------------------------
# PATHS
# ------------------------------------------------------------------------------
paths:
  /flags:
    get:
      summary: List feature flags
      description: Retrieves a list of feature flags with pagination.
      operationId: listFlags
      tags: [Flags]
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number.
        - in: query
          name: page_size
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: Number of items per page.
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedFlagList'
        '400':
          description: Invalid pagination parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a new flag
      description: Creates a new feature flag definition.
      operationId: createFlag
      tags: [Flags]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFlagRequest'
      responses:
        '201':
          description: Flag created successfully
          headers:
            ETag:
              schema:
                type: string
              description: |
                Entity tag for the created flag. Format: "<sequence_number>".
                Used for optimistic locking in subsequent updates.
              example: "1"
            Cache-Control:
              schema:
                type: string
              description: Cache control directive.
              example: "no-cache"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Flag'
        '400':
          description: Invalid input (e.g., invalid key format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - A flag with this key already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /flags/{key}:
    parameters:
      - in: path
        name: key
        schema:
          type: string
        required: true
        description: The unique natural key of the flag.
    
    get:
      summary: Get a flag
      description: Retrieves detailed information about a specific flag.
      operationId: getFlag
      tags: [Flags]
      responses:
        '200':
          description: Flag details
          headers:
            ETag:
              schema:
                type: string
              description: |
                Entity tag representing the current version of the flag.
                Format: "<sequence_number>". Required for subsequent updates.
              example: "5"
            Cache-Control:
              schema:
                type: string
              description: Cache control directive.
              example: "no-cache"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Flag'
        '404':
          description: Flag not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      summary: Update a flag
      description: |
        Updates specific fields of a flag (Partial Update).
        Requires the If-Match header with the current ETag to prevent lost updates.
      operationId: updateFlag
      tags: [Flags]
      parameters:
        - in: header
          name: If-Match
          schema:
            type: string
          required: true
          description: |
            ETag value from a previous GET request. Used for optimistic locking.
            Must match the current version of the flag or the update will fail with 412.
          example: "5"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateFlagRequest'
      responses:
        '200':
          description: Flag updated successfully
          headers:
            ETag:
              schema:
                type: string
              description: |
                New entity tag after the update. Save this for subsequent updates.
              example: "6"
            Cache-Control:
              schema:
                type: string
              description: Cache control directive.
              example: "no-cache"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Flag'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Flag not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '412':
          description: |
            Precondition Failed - The If-Match ETag does not match the current version.
            The flag has been modified by another request.
            Client must GET the latest flag state before retrying the update.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: "ERR_PRECONDITION_FAILED"
                message: "The flag has been modified. Please fetch the latest version and retry."
        '428':
          description: |
            Precondition Required - The If-Match header is missing.
            All updates require an ETag for optimistic locking.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: "ERR_PRECONDITION_REQUIRED"
                message: "The If-Match header is required for updates. Please fetch the flag first to obtain an ETag."

    delete:
      summary: Delete a flag
      description: |
        Deletes a feature flag.
        Requires the If-Match header with the current ETag to prevent accidental deletion.
      operationId: deleteFlag
      tags: [Flags]
      parameters:
        - in: header
          name: If-Match
          schema:
            type: string
          required: true
          description: |
            ETag value from a previous GET request. Used for optimistic locking.
            Must match the current version of the flag or the delete will fail with 412.
          example: "5"
      responses:
        '204':
          description: Flag deleted successfully
        '404':
          description: Flag not found
        '412':
          description: |
            Precondition Failed - The If-Match ETag does not match the current version.
            The flag has been modified by another request.
            Client must GET the latest flag state before retrying the delete.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '428':
          description: |
            Precondition Required - The If-Match header is missing.
            All deletes require an ETag for optimistic locking.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
